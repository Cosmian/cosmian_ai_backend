---
  name: Build, test and release

  on: [push]

  jobs:
    build:
      runs-on: ubuntu-latest
      steps:
          - uses: actions/checkout@v3
          - uses: actions/setup-python@v3
            with:
              python-version: 3.8
          - name: Install dependencies
            run: |
                python -m pip install --upgrade pip
                pip install flake8 build
          - name: Linter
            run: |
                cd app/
                flake8 --max-line-length=100 --ignore E501,E203
          - name: Build package
            run: |
                cd app/
                python -m build
          - uses: actions/upload-artifact@v3
            with:
              name: cosmian_ai_backend_dist
              path: ./app/dist
              retention-days: 10

    test:
      runs-on: ubuntu-latest
      needs: build
      steps:
        - uses: actions/checkout@v3
        - uses: actions/setup-python@v3
          with:
            python-version: 3.8
        - name: Download artifact
          uses: actions/download-artifact@v3
          with:
            name: cosmian_ai_backend_dist
            path: ./dist
        - name: Install dependencies
          run: |
            python -m pip install --upgrade pip
            pip install dist/*.whl
        - name: Run tests
          run: |
              CONFIG_PATH="./app/tests/config.json" python -m unittest app/tests/test*.py

    release:
      needs: build
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v3
        - name: Download artifact
          uses: actions/download-artifact@v3
          with:
            name: cosmian_ai_backend_dist
            path: ./dist
        - name: Release on tags, attach asset on release
          if: startsWith(github.ref, 'refs/tags/')
          uses: softprops/action-gh-release@v1
          with:
            files: dist/*

    push:
      needs: build
      name: package.cosmian.com
      runs-on: [self-hosted, no-tee]
      steps:
        - name: Download artifact
          uses: actions/download-artifact@v4
          with:
            name: cosmian_ai_backend_dist
  
        - name: Push latest build to package.cosmian.com
          run: |
            set -x
            export BRANCH=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}
            DESTINATION_DIR=/mnt/package/cosmian_ai_backend/last_build/${BRANCH}
            ssh cosmian@package.cosmian.com mkdir -p $DESTINATION_DIR
            scp app/dist/cosmian_ai_runner-0.3.0-py3-none-any.whl cosmian@package.cosmian.com:$DESTINATION_DIR/
  
        - name: Push version tag to package.cosmian.com
          if: startsWith(github.ref, 'refs/tags/')
          env:
            VERSION: ${{ github.ref_name }}
          run: |
            set -x
            DESTINATION_DIR=/mnt/package/cosmian_ai_backend/$VERSION
            ssh cosmian@package.cosmian.com mkdir -p $DESTINATION_DIR
            scp app/dist/cosmian_ai_runner-0.3.0-py3-none-any.whl cosmian@package.cosmian.com:$DESTINATION_DIR/
          